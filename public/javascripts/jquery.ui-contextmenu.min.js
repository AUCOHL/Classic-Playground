(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","jquery-ui/menu"],factory)}else{factory(jQuery)}})(function($){"use strict";var supportSelectstart="onselectstart"in document.createElement("div"),match=$.ui.menu.version.match(/^(\d)\.(\d+)/),uiVersion={major:parseInt(match[1],10),minor:parseInt(match[2],10)},isLTE110=uiVersion.major<2&&uiVersion.minor<11;$.widget("moogle.contextmenu",{version:"@VERSION",options:{addClass:"ui-contextmenu",autoFocus:false,autoTrigger:true,delegate:null,hide:{effect:"fadeOut",duration:"fast"},ignoreParentSelect:true,menu:null,position:null,preventContextMenuForPopup:false,preventSelect:false,show:{effect:"slideDown",duration:"fast"},taphold:false,uiMenuOptions:{},beforeOpen:$.noop,blur:$.noop,close:$.noop,create:$.noop,createMenu:$.noop,focus:$.noop,open:$.noop,select:$.noop},_create:function(){var cssText,eventNames,targetId,opts=this.options;this.$headStyle=null;this.$menu=null;this.menuIsTemp=false;this.currentTarget=null;this.previousFocus=null;if(opts.preventSelect){targetId=($(this.element).is(document)?$("body"):this.element).uniqueId().attr("id");cssText="#"+targetId+" "+opts.delegate+" { "+"-webkit-user-select: none; "+"-khtml-user-select: none; "+"-moz-user-select: none; "+"-ms-user-select: none; "+"user-select: none; "+"}";this.$headStyle=$("<style class='moogle-contextmenu-style' />").prop("type","text/css").appendTo("head");try{this.$headStyle.html(cssText)}catch(e){this.$headStyle[0].styleSheet.cssText=cssText}if(supportSelectstart){this.element.delegate(opts.delegate,"selectstart"+this.eventNamespace,function(event){event.preventDefault()})}}this._createUiMenu(opts.menu);eventNames="contextmenu"+this.eventNamespace;if(opts.taphold){eventNames+=" taphold"+this.eventNamespace}this.element.delegate(opts.delegate,eventNames,$.proxy(this._openMenu,this))},_destroy:function(){this.element.undelegate(this.eventNamespace);this._createUiMenu(null);if(this.$headStyle){this.$headStyle.remove();this.$headStyle=null}},_createUiMenu:function(menuDef){var ct,opts=this.options;if(this.isOpen()){ct=this.currentTarget;this._closeMenu(true);this.currentTarget=ct}if(this.menuIsTemp){this.$menu.remove()}else if(this.$menu){this.$menu.menu("destroy").removeClass(this.options.addClass).hide()}this.$menu=null;this.menuIsTemp=false;if(!menuDef){return}else if($.isArray(menuDef)){this.$menu=$.moogle.contextmenu.createMenuMarkup(menuDef);this.menuIsTemp=true}else if(typeof menuDef==="string"){this.$menu=$(menuDef)}else{this.$menu=menuDef}this.$menu.hide().addClass(opts.addClass).menu($.extend(true,{},opts.uiMenuOptions,{blur:$.proxy(opts.blur,this),create:$.proxy(opts.createMenu,this),focus:$.proxy(opts.focus,this),select:$.proxy(function(event,ui){var retval,isParent=$.moogle.contextmenu.isMenu(ui.item),actionHandler=ui.item.data("actionHandler");ui.cmd=ui.item.attr("data-command");ui.target=$(this.currentTarget);if(!isParent||!opts.ignoreParentSelect){retval=this._trigger.call(this,"select",event,ui);if(actionHandler){retval=actionHandler.call(this,event,ui)}if(retval!==false){this._closeMenu.call(this)}event.preventDefault()}},this)}))},_openMenu:function(event,recursive){var res,promise,opts=this.options,posOption=opts.position,self=this,manualTrigger=!!event.isTrigger,ui={menu:this.$menu,target:$(event.target),extraData:event.extraData,originalEvent:event,result:null};if(!opts.autoTrigger&&!manualTrigger){return}event.preventDefault();this.currentTarget=event.target;if(!recursive){res=this._trigger("beforeOpen",event,ui);promise=ui.result&&$.isFunction(ui.result.promise)?ui.result:null;ui.result=null;if(res===false){this.currentTarget=null;return false}else if(promise){promise.done(function(){self._openMenu(event,true)});this.currentTarget=null;return false}ui.menu=this.$menu}$(document).bind("keydown"+this.eventNamespace,function(event){if(event.which===$.ui.keyCode.ESCAPE){self._closeMenu()}}).bind("mousedown"+this.eventNamespace+" touchstart"+this.eventNamespace,function(event){if(!$(event.target).closest(".ui-menu-item").length){self._closeMenu()}});if($.isFunction(posOption)){posOption=posOption(event,ui)}posOption=$.extend({my:"left top",at:"left bottom",of:event.pageX===undefined?event.target:event,collision:"fit"},posOption);this.$menu.show().css({position:"absolute",left:0,top:0}).position(posOption).hide();if(opts.preventContextMenuForPopup){this.$menu.bind("contextmenu"+this.eventNamespace,function(event){event.preventDefault()})}this._show(this.$menu,opts.show,function(){if(opts.autoFocus){self.$menu.focus();self.previousFocus=$(event.target)}self._trigger.call(self,"open",event,ui)})},_closeMenu:function(immediately){var self=this,hideOpts=immediately?false:this.options.hide;$(document).unbind("mousedown"+this.eventNamespace).unbind("touchstart"+this.eventNamespace).unbind("keydown"+this.eventNamespace);self.currentTarget=null;if(this.$menu){this.$menu.unbind("contextmenu"+this.eventNamespace);this._hide(this.$menu,hideOpts,function(){if(self.previousFocus){self.previousFocus.focus();self.previousFocus=null}self._trigger("close")})}else{self._trigger("close")}},_setOption:function(key,value){switch(key){case"menu":this.replaceMenu(value);break}$.Widget.prototype._setOption.apply(this,arguments)},_getMenuEntry:function(cmd){return this.$menu.find("li[data-command="+cmd+"]")},close:function(){if(this.isOpen()){this._closeMenu()}},enableEntry:function(cmd,flag){this._getMenuEntry(cmd).toggleClass("ui-state-disabled",flag===false)},getMenu:function(){return this.$menu},isOpen:function(){return!!this.$menu&&!!this.currentTarget},open:function(target,extraData){extraData=extraData||{};var e=jQuery.Event("contextmenu",{target:target.get(0),extraData:extraData});return this.element.trigger(e)},replaceMenu:function(data){this._createUiMenu(data)},setEntry:function(cmd,entry){var $ul,$entryLi=this._getMenuEntry(cmd);if(typeof entry==="string"){$.moogle.contextmenu.updateTitle($entryLi,entry)}else{$entryLi.empty();entry.cmd=entry.cmd||cmd;$.moogle.contextmenu.createEntryMarkup(entry,$entryLi);if($.isArray(entry.children)){$ul=$("<ul/>").appendTo($entryLi);$.moogle.contextmenu.createMenuMarkup(entry.children,$ul)}this.getMenu().menu("refresh")}},showEntry:function(cmd,flag){this._getMenuEntry(cmd).toggle(flag!==false)}});$.extend($.moogle.contextmenu,{createEntryMarkup:function(entry,$parentLi){var $a=null;$parentLi.attr("data-command",entry.cmd);if(!/[^\-\u2014\u2013\s]/.test(entry.title)){$parentLi.text(entry.title)}else{if(isLTE110){$a=$("<a/>",{html:""+entry.title,href:"#"}).appendTo($parentLi);if(entry.uiIcon){$a.append($("<span class='ui-icon' />").addClass(entry.uiIcon))}}else{$parentLi.html(""+entry.title);if($.isFunction(entry.action)){$parentLi.data("actionHandler",entry.action)}if(entry.uiIcon){$parentLi.append($("<span class='ui-icon' />").addClass(entry.uiIcon))}}if($.isFunction(entry.action)){$parentLi.data("actionHandler",entry.action)}if(entry.disabled){$parentLi.addClass("ui-state-disabled")}if(entry.addClass){$parentLi.addClass(entry.addClass)}if($.isPlainObject(entry.data)){$parentLi.data(entry.data)}if(entry.tooltip!=null){$parentLi.attr("title",entry.tooltip)}}},createMenuMarkup:function(options,$parentUl){var i,menu,$ul,$li;if($parentUl==null){$parentUl=$("<ul class='ui-helper-hidden' />").appendTo("body")}for(i=0;i<options.length;i++){menu=options[i];$li=$("<li/>").appendTo($parentUl);$.moogle.contextmenu.createEntryMarkup(menu,$li);if($.isArray(menu.children)){$ul=$("<ul/>").appendTo($li);$.moogle.contextmenu.createMenuMarkup(menu.children,$ul)}}return $parentUl},isMenu:function(item){if(isLTE110){return item.has(">a[aria-haspopup='true']").length>0}else{return item.is("[aria-haspopup='true']")}},replaceFirstTextNodeChild:function(elem,text){elem.contents().filter(function(){return this.nodeType===3}).first().replaceWith(text)},updateTitle:function(item,title){if(isLTE110){$.moogle.contextmenu.replaceFirstTextNodeChild($("a",item),title)}else{$.moogle.contextmenu.replaceFirstTextNodeChild(item,title)}}})});
